name: main
inputs:
  - name: sensor-grid-count
    type: DAGIntegerInput
    annotations: {}
    description: The maximum number of grid points per parallel execution
  - name: radiance-parameters
    type: DAGStringInput
    annotations: {}
    description: The radiance parameters for ray tracing
    default: -I -ab 2 -h
  - annotations: {}
    type: DAGFileInput
    name: model_hbjson
    description: Honeybee model as a hbjson file.
    default: null
    spec: null
    handler:
      - type: InputHandler
        platform:
        - grasshopper
        name: model
        description: |
            A path to a HBJSON file or a HB model object built with Python or dotnet
            libraries.
        action:
        - type: HandlerAction
          case:
          - python-object
          script: |
            import tempfile, os
            path = os.path.join(tempfile.TemporaryDirectory().name, '%s.hbjson' % model.identifier)
            with open(path, 'w') as outf:
                json.dump(model.to_dict(), outf)
          return: path
        - type: HandlerAction
          case:
          - string
          script: null
      - type: InputHandler
        platform:
        - revit
        - rhino
        link: Model  # link to live Rhino / Revit model
        action:
        - type: HandlerAction
          case:
          - dotnet
          script: |
            {
              //Some C# code here;
            }
          return: ModelJSONPath
  - name: input-grid
    type: DAGFileInput
    annotations: {}
    description: A grid file

tasks:

- name: generate-sky
  template: honeybee-radiance/10000-lux-sky
  returns:
    - name: sky
      type: TaskPathReturn
      path: asset/sky/10000_lux.sky

- name: split-grid
  template: honeybee-radiance/split-grid
  arguments:
    - name: grid-count
      type: TaskArgument
      from:
        type: InputReference
        variable: sensor-grid-count
    - name: grid
      type: TaskPathArgument
      from:
        type: InputFileReference
        variable: input-grid
  returns:
    - name: grid-list
      type: TaskReturn
    - name: output-grids-folder
      type: TaskPathReturn
      path: output/temp

- name: create-octree
  template: honeybee-radiance/create-octree
  dependencies:
  - generate-sky
  arguments:
    - name: model
      type: TaskPathArgument
      from:
        type: InputFolderReference
        variable: model_hbjson
    - name: sky
      type: TaskPathArgument
      from:
        type: TaskFileReference
        name: generate-sky
        variable: sky
  returns:
    - name: scene-file
      type: TaskPathReturn
      path: output/octree/scene.oct
  
- name: daylight-factor-simulation
  template: honeybee-radiance/ray-tracing
  dependencies:
  - split-grid
  - create-octree
  loop:
    from:
      type: TaskReference
      name: split-grid
      variable: grid-list
  sub_folder: output/raw-results
  arguments:
    - name: radiance-parameters
      type: TaskArgument
      from:
        type: InputReference
        variable: radiance-parameters
    - name: grid
      type: TaskPathArgument
      from:
        type: TaskFolderReference
        name: split-grid
        variable: output-grids-folder
      sub_path: '{{item.name}}'
    - name: scene-file
      type: TaskPathArgument
      from:
        type: TaskFileReference
        name: create-octree
        variable: scene-file
  returns:
    - name: result-file
      type: TaskPathReturn
      path: '{{item.name}}.res'

- name: post-process
  template: honeybee-radiance/post-process
  dependencies:
  - daylight-factor-simulation
  arguments:
    - name: raw-results-folder
      type: TaskPathArgument
      from:
        type: ValueFolderReference
        path: output/raw-results
  returns:
    - name: post-process-folder
      type: TaskPathReturn
      path: result
    - name: daylight-factor-average
      type: TaskReturn

outputs:
  - name: data
    type: DAGFolderOutput
    from:
      type: TaskReference
      name: post-process
      variable: post-process-folder
  - name: average
    type: DAGIntegerOutput
    from:
      type: TaskReference
      name: post-process
      variable: daylight-factor-average
